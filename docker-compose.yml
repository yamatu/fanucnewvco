services:
  mysql:
    image: mysql:8.0
    container_name: fanuc_mysql
    command:
      - "--default-authentication-plugin=mysql_native_password"
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_unicode_ci"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-change_me_root_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-fanuc_sales}
      MYSQL_USER: ${MYSQL_USER:-fanuc}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-change_me_db_password}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD"]
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  backend:
    build:
      context: ./backend
    container_name: fanuc_backend
    environment:
      GO_ENV: production
      GIN_MODE: release
      HOST: 0.0.0.0
      PORT: 8080

      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${MYSQL_USER:-fanuc}
      DB_PASSWORD: ${MYSQL_PASSWORD:-change_me_db_password}
      DB_NAME: ${MYSQL_DATABASE:-fanuc_sales}

      JWT_SECRET: ${JWT_SECRET:-please_change_me_in_production}
      JWT_EXPIRES_HOURS: ${JWT_EXPIRES_HOURS:-24}
      CUSTOMER_JWT_EXPIRES_HOURS: ${CUSTOMER_JWT_EXPIRES_HOURS:-168}

      # 是否自动迁移（生产环境建议配合备份谨慎开启）
      DB_AUTO_MIGRATE: ${DB_AUTO_MIGRATE:-true}

      # 默认管理员（生产环境建议首次初始化后关闭 SEED_DEFAULT_ADMIN）
      SEED_DEFAULT_ADMIN: ${SEED_DEFAULT_ADMIN:-false}
      DEFAULT_ADMIN_PASSWORD: ${DEFAULT_ADMIN_PASSWORD:-}
      RESET_DEFAULT_ADMIN_PASSWORD: ${RESET_DEFAULT_ADMIN_PASSWORD:-false}
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - ./backend/uploads:/app/uploads
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      args:
        # 仅用于 SSR 端访问后端（浏览器端会走 /api/v1 相对路径）
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://backend:8080}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-http://localhost}
        NEXT_PUBLIC_SITE_NAME: ${NEXT_PUBLIC_SITE_NAME:-FANUC Parts Store}
        NEXT_PUBLIC_SITE_DESCRIPTION: ${NEXT_PUBLIC_SITE_DESCRIPTION:-Professional FANUC Parts and Equipment Sales}
        NEXT_PUBLIC_PAYPAL_CLIENT_ID: ${NEXT_PUBLIC_PAYPAL_CLIENT_ID:-}
        NEXT_PUBLIC_PAYPAL_ENVIRONMENT: ${NEXT_PUBLIC_PAYPAL_ENVIRONMENT:-sandbox}
    container_name: fanuc_frontend
    environment:
      NODE_ENV: production
      PORT: 3000
      HOSTNAME: 0.0.0.0
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:1.27-alpine
    container_name: fanuc_nginx
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend
    restart: unless-stopped

volumes:
  mysql_data:
