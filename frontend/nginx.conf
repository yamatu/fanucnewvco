# /etc/nginx/nginx.conf
user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 10240;
    multi_accept on;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # 日志配置
    access_log  /var/log/nginx/access.log;
    error_log   /var/log/nginx/error.log warn;

    # 性能优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;
    client_max_body_size 2048m;

    # Gzip 压缩 - SEO优化，包含sitemap和robots文件
    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/x-javascript
        application/xml
        application/xml+rss
        application/rss+xml
        application/atom+xml
        image/svg+xml;

    # 反向代理缓存优化
    proxy_buffering off;
    proxy_buffers 16 16k;
    proxy_buffer_size 32k;

    # SSL 设置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 服务器配置
    server {
        listen 80;
        server_name www.vcocncspare.com vcocncspare.com;

        # HTTP 自动跳转 HTTPS
        return 301 https://$host$request_uri;
    }

    # 新站点 HTTP：kindanddivine.com / www.kindanddivine.com
    # 所有 HTTP 访问统一跳转到 HTTPS 的 www 域名
    server {
        listen 80;
        server_name kindanddivine.com www.kindanddivine.com;

        # 301 永久重定向到 https://www.kindanddivine.com
        return 301 https://www.kindanddivine.com$request_uri;
    }

    # 站点一：vcocncspare.com（保持不变）
    server {
        listen 443 ssl http2;
        server_name www.vcocncspare.com vcocncspare.com;

        ssl_certificate     /root/.acme.sh/www.vcocncspare.com_ecc/fullchain.cer;
        ssl_certificate_key /root/.acme.sh/www.vcocncspare.com_ecc/www.vcocncspare.com.key;

        # SEO优化：确保使用www域名
        if ($host = vcocncspare.com) {
            return 301 https://www.vcocncspare.com$request_uri;
        }

        # SEO和安全头部
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Security: Strip x-middleware-subrequest header to prevent CVE-2025-29927
        proxy_set_header x-middleware-subrequest "";

        # Next.js 静态资源 - 仅对真正的静态资源缓存
        location /_next/static/ {
            proxy_pass http://127.0.0.1:3000;
            expires 1y;
            access_log off;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # SEO关键文件 - 无缓存确保搜索引擎获取最新内容
        location = /favicon.ico {
            proxy_pass http://127.0.0.1:3000;
            access_log off;
            log_not_found off;
        }

        location = /robots.txt {
            proxy_pass http://127.0.0.1:3000/robots.txt;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
            access_log off;
            log_not_found off;
        }

        # 主sitemap - 无缓存确保搜索引擎获取最新内容
        location = /sitemap.xml {
            proxy_pass http://127.0.0.1:3000/sitemap.xml;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
        }

        # 兼容旧站风格的 xmlsitemap.php，转发到后端服务
        location = /xmlsitemap.php {
            proxy_pass http://127.0.0.1:8080; # Gin 路由已定义 /xmlsitemap.php
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
            add_header Content-Type "application/xml" always;
        }

        # 所有sitemap文件 - 无缓存确保搜索引擎获取最新内容
        location ~* ^/sitemap.*\.xml$ {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
            add_header Content-Type "application/xml" always;
        }

        # API 路由代理到后端 - 这是关键配置！
        location /api/ {
            proxy_pass http://127.0.0.1:8080;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            
            # CORS 头部配置
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization, X-Requested-With" always;
            
            # 处理预检请求
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization, X-Requested-With";
                add_header Access-Control-Max-Age 1728000;
                add_header Content-Type "text/plain; charset=utf-8";
                add_header Content-Length 0;
                return 204;
            }
            
            # 超时配置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # 不缓存API响应
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # 健康检查端点代理
        location /health {
            proxy_pass http://127.0.0.1:8080;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            access_log off;
        }

        # 产品页面 - SEO优化，无缓存确保搜索引擎获取最新内容
        location ~* ^/products/ {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_read_timeout 60s;

            # SEO优化：无缓存确保搜索引擎获取最新产品信息
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;

            # SEO友好的头部（由页面自行控制 robots）
            add_header X-Content-Type-Options "nosniff" always;
        }

        # 分类页面 - SEO优化，无缓存
        location ~* ^/categories/ {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_read_timeout 60s;

            # SEO优化：无缓存确保搜索引擎获取最新分类信息
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;

            # SEO友好的头部（由页面自行控制 robots）
            add_header X-Content-Type-Options "nosniff" always;
        }

        # 反代 Next.js - 其他页面
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_read_timeout 60s;

            # 一般页面短时间缓存，但确保搜索引擎能获取最新内容
            add_header Cache-Control "no-cache, must-revalidate" always;
            add_header Pragma "no-cache" always;

            # SEO友好的头部（由页面自行控制 robots）
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
        }
    }

    # 站点二：kindanddivine.com（你的新网站）
    server {
        listen 443 ssl http2;
        server_name www.kindanddivine.com kindanddivine.com;

        # 注意：以下证书路径请根据你在服务器上申请的实际证书路径调整
        ssl_certificate     /root/.acme.sh/www.kindanddivine.com_ecc/fullchain.cer;
        ssl_certificate_key /root/.acme.sh/www.kindanddivine.com_ecc/www.kindanddivine.com.key;

        # 确保最终使用 www 子域名
        if ($host = kindanddivine.com) {
            return 301 https://www.kindanddivine.com$request_uri;
        }

        # 代码所在目录（前端项目根目录），主要做记录说明
        root /root/yan;
        index index.html;

        # 独立的访问日志和错误日志
        access_log /var/log/nginx/kindanddivine.access.log;
        error_log  /var/log/nginx/kindanddivine.error.log warn;

        # SEO和安全头部
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # 防护中间件头
        proxy_set_header x-middleware-subrequest "";

        # Next.js 静态资源 - 仅对真正的静态资源缓存
        # 这里前端服务跑在 3001 端口（Docker 或 node 进程都可以），Nginx 只负责反向代理
        location /_next/static/ {
            proxy_pass http://127.0.0.1:3001;
            expires 1y;
            access_log off;
            add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # SEO关键文件 - 无缓存确保搜索引擎获取最新内容
        location = /favicon.ico {
            proxy_pass http://127.0.0.1:3001;
            access_log off;
            log_not_found off;
        }

        location = /robots.txt {
            proxy_pass http://127.0.0.1:3001/robots.txt;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
            access_log off;
            log_not_found off;
        }

        # 主 sitemap
        location = /sitemap.xml {
            proxy_pass http://127.0.0.1:3001/sitemap.xml;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
        }

        # 所有 sitemap*.xml
        location ~* ^/sitemap.*\.xml$ {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
            add_header Content-Type "application/xml" always;
        }

        # API 路由代理到后端（你的 Go 后端在 /root/yan/backend，端口用 .env 里的 9001）
        location /api/ {
            proxy_pass http://127.0.0.1:9001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            
            # CORS 头部配置（如不需要可精简）
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization, X-Requested-With" always;
            
            # 处理预检请求
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization, X-Requested-With";
                add_header Access-Control-Max-Age 1728000;
                add_header Content-Type "text/plain; charset=utf-8";
                add_header Content-Length 0;
                return 204;
            }
            
            # 超时配置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # 不缓存API响应
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # 健康检查端点代理
        location /health {
            proxy_pass http://127.0.0.1:9001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            access_log off;
        }

        # 反代 Next.js - 其他页面
        location / {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_read_timeout 60s;

            # 一般页面短时间缓存，但确保搜索引擎能获取最新内容
            add_header Cache-Control "no-cache, must-revalidate" always;
            add_header Pragma "no-cache" always;

            # SEO友好的头部（由页面自行控制 robots）
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "SAMEORIGIN" always;
        }
    }
}